---
title: "2.1 Matching"
author: "Lauke"
date: "05/04/2022"
output: html_document
---

```{r Set seed}
set.seed(123)
```

```{r load in data}
load("~/GitHub/Master_Thesis/Analyses/Workspaces/step1_dat.Rdata")
load("~/GitHub/Master_Thesis/Analyses/Workspaces/prop_scores.Rdata")
```

```{r Libraries}
#require(devtools)
#remotes::install_github("markmfredrickson/optmatch")
library(optmatch) #for optimal full matching algorithm used in MatchIt package
library(MatchIt)
library(haven) #still necessary for working with step1_dat format
```


# a. Match sub-samples based on each of m.iter sets of propensity scores - USING PAIR MATCH - run again with ATT now

```{r Optimal pair matching using MatchIt}
gc()
start_time <- Sys.time()

pairmatches <- apply(prop_scores[1:3,], 1, function(x) {matchit(group ~ as.factor(Gender) + AGE + GRADE + ISCEDL + ESCS + as.factor(Language), distance = x, method = "optimal", estimand = "ATT", data = step1_dat)})

end_time <- Sys.time()
```

NB: pairmatch needs ATT/ATC cannot do ATE.

```{r Outcome and computation time}
summary(pairmatches[[1]])
comptime_pairmatch <- end_time - start_time #1.2 hrs
object.size(pairmatches) #13.5 MB
```

```{r Save pairmatch output}
save(pairmatches, file = "Workspaces/pairmatches.Rdata")
```


# b. Create matched data sets - USING PAIR MATCH

```{r Creating matches datasets}
#create datasets
pairmatchdat <- lapply(pairmatches, function(x) {match.data(x, group = "all", distance = "prop.score", data = step1_dat, drop.unmatched = T)})
```

```{r}
save(pairmatchdat, file = "Workspaces/pairmatchdat.Rdata")
```
